<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project 1: Prokudin-Gorskii Image Alignment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        p {
            max-width: 800px;
        }
        img {
            max-width: 100%
        }
       .image-caption {
            margin-top: 10px;
            font-size: 1.5em;
            color: #111;
            font-weight: bold;
            text-align: center;
        }
        .row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        .row div {
            text-align: center;
        }
        .row img {
            max-width: 300px;
            border: 1px solid #ccc;
        }
        #example-images {
            font-size: 3em;
            text-align: center;
            text-decoration: underline;
            color: #111;
        }
        #chosen-images {
            font-size: 3em;
            text-align: center;
            text-decoration: underline;
            color: #111;
        }
        #note {
            text-align: center;
            color: #111;
            font-size: 1em;
        }
        .intro-text {
            flex: 2;
            text-align: left;
        }
        .intro-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        .intro-image {
            flex: 1;
        }

        .intro-image img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="intro-container">
    <div class="intro-text">
    <h1>Project 1: Prokudin-Gorskii Image Alignment</h1>

    <p>
        Sergei Mikhailovich Prokudin-Gorskii was a Russian photographer who documented early 20th century Russia through three-image color photography.
        He recorded three exposures of every scene onto a glass plate using red, green, and blue filters. Although he was never able to see his black and white plates turned into a single color image, his RGB glass plate negatives were digitized and now are being turned by me, over 100 years later, into color photographs.
    </p>

    <h2>Overview</h2>
    <p>
        I will turn the digitized Prokudin-Gorskii plates (a 3-channel image) into a color image with minimal visual artifacts by using image alignment and automatic cropping techniques. This involves extracting the three color channels, aligning each channel to a consistent anchor channel, stacking them on top of each other, and then cropping any black borders or color streaks/splotches.
    </p>

    <h2>Approach</h2>
    <h3>Naive and Image Pyramid Solution to Alignment</h3>
    <p>
        I aligned images in two ways. The naive solution involved using two image matching metrics: Normalized Cross Correlation (NCC)
        and L2 Norm (Euclidean Distance). While these photos utilized Normalized Cross Correlation (NCC), 
        my code can align images properly with both NCC and the L2 Norm (Euclidean Distance).
        First I sliced the 3-channel image into individual channel arrays. Then I aligned 2 of the channels individually to a chosen
        anchor channel. For both image matching metrics,
        an array is aligned with an anchor array at a certain displacement. Choosing the displacement that best aligns the images
        is done by searching over a window of possible displacements, rolling the input array in the direction of a given
        displacement, and then calculating some equation For Euclidean Distance the equation is: 
        sqrt(sum(sum((input_array - anchor_array).^2))), whereas for NCC it is: (image1./||image1|| and image2./||image2||). If the
        equation output is closest to zero (Euclidean Distance) or closest to 1 (NCC) then that displacement is the best displacement.
        This is because Euclidean Distance measures the absolute difference in pixel intesity between two arrays, so two images will be aligned
        if the sum of their squared differences is very small or near zero. In contrast, NCC measures the cosine similarity between two image vectors,
        with a perfect correlation being 1 and an inverse correlation being -1, so an image is aligned if the dot product between two normalized
        vectors is near 1. Calculating these displacements is quick if done on a small scale image (.jpg), but when done on a large scale image (.tif)
        calculations take too long. Instead of just rolling and calculating an image matching metric for a 300x300 image you are now doing that on a 3000 x 3000 image.
        To speed this up, I implemented an image pyramid. This works by aligning the image at a small scale by downsampling it, and then gradually resizing
        it to its original size, checking smaller and smaller displacement windows as you move down the pyramid. This way it checks a large area with a small resolution array
        and then makes minor adjustments with the larger images. For example, instead of checking a 50x50 displacement window on a 3000x3000 image, you
        can check a 50x50 window on that same image but resized down to 100x100, then resize it to 200x200 and check a 25x25 window, and so on and so on.
        This drastically speeds up the search while still aligning properly. The resizing effectively takes out every other row and column, and keeps doing
        this each time you downsample (resize down). So an image may seem aligned at the top of the pyramid (when its smallest) but will still need minor
        tweaks for each level of the pyramid to ensure the most accurate and proper alignment.
        I found that using the green channel as an anchor produced the best alignments across all images. I also found that pre-cropping the image arbitrarily
        before checking for alignment avoided issues with Euclidean Distance and NCC where it would be confused by the black bars on the edges of the image
        and treat those lines as an actual part of the image and include their pixel values in the calculations.
        The values I had to tweak where what scale worked best for the pyramid (i found a scale of 4 worked best as it didnt have too many layers, so there were less checks but
        it also wasnt such a high scale that alignment would suffer. think of the case where the scale is 100 and so it resizes down by 100, immediately hits the base image size, aligns on that
        small image, and then immediately checks on the full size image. the alignment is likely to be off unless we spend a lot of time searching the larger image, which effectively
        defeats the point of the image pyramid).
    </p>
    <br>
    <h3>Bells and Whistles: Automatic Cropping</h3>
    <br>
    <p>
        I did automatic cropping which removed both the black borders and the colored borders on the edges of my images. I first
        converted my aligned images to grayscale to focus on only a single channel: the intensity of the pixel. I then went from each edge
        inwards and checked  the given row or column's mean. If the mean of the next row/column was larger than the current row/column by a
        certain amount, then i must have found a border going from black (low mean) to white (high mean) or just going from very dark to somewhat bright.
        I noted everytime the difference in the mean's between each row/column crossed a certain threshold, and then added it to an array. I would
        then crop the image according to the last dy or dx where that happened. I did a similar cropping procedure for color, but
        instead of checking for difference in mean, I checked for a multitude of factors. I checked for splotches or peaks (areas where one of the three
        channels on a pixel hit a value of 255 or 1). I also checked for pixels being above a certain number since most color splotches were bright or
        peaked in their given channel, i.e. were above 230 or so. Then I checked for differences between channels for each pixel since a color border
        pixel normally had massive differences between its maximum value in a channel and its minimum value in another channel. 
        The values I tweaked were how far in to check for cropping, the threshold for difference in mean for the black border cropping, and the exact amount a pixel
        had to be larger than or the exact value that a difference between the max and min values across the 3 channels would have to be.
    </p>
    </div>

     <div class="intro-image">
            <img src="mediaone/arrow.png" alt="Arrow">
    </div>
    </div>
    
    <br>
    <br>

   <h2 id="example-images">Example Images</h2>
    <h4 id="note">Note: Cathedral, Monastery, and Tobolsk were aligned using single-scale alignment</h4>
    
    <br>

    <div class="image-wrapper">
        <div class="image-caption">Cathedral</div>
        <img src="mediaone/cathedral.png" alt="Cathedral">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Church</div>
        <img src="mediaone/church.png" alt="Church">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Emir</div>
        <img src="mediaone/emir.png" alt="Emir">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Self Portrait</div>
        <img src="mediaone/selfPortrait.png" alt="Self Portrait">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Harvesters</div>
        <img src="mediaone/harvesters.png" alt="Harvesters">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Icon</div>
        <img src="mediaone/icon.png" alt="Icon">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Italil</div>
        <img src="mediaone/italil.png" alt="Italil">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Siren</div>
        <img src="mediaone/siren.png" alt="Siren">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Lastochikino</div>
        <img src="mediaone/lastochikino.png" alt="Lastochikino">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Lugano</div>
        <img src="mediaone/lugano.png" alt="Lugano">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Melons</div>
        <img src="mediaone/melons.png" alt="Melons">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Monastery</div>
        <img src="mediaone/monastery.png" alt="Monastery">
    </div>
    
    <h2 id="chosen-images">Chosen Images</h2>

    <div class="image-wrapper">
        <div class="image-caption">Lake</div>
        <img src="mediaone/lake.png" alt="Lake">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Clothes</div>
        <img src="mediaone/clothes.png" alt="Clothes">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Rug</div>
        <img src="mediaone/rug.png" alt="Rug">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Sunset</div>
        <img src="mediaone/sunset.png" alt="Sunset">
    </div>

    <div class="image-wrapper">
        <div class="image-caption">Dam</div>
        <img src="mediaone/dam.png" alt="Dam">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Forest Walk</div>
        <img src="mediaone/forestWalk.png" alt="Forest Walk">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Jesus</div>
        <img src="mediaone/jesus.png" alt="Jesus">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Land Church</div>
        <img src="mediaone/landChurch.png" alt="Land Church">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Men Wood</div>
        <img src="mediaone/menWood.png" alt="Men Wood">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Model</div>
        <img src="mediaone/model.png" alt="Model">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Orange Lake</div>
        <img src="mediaone/orangeLake.png" alt="Orange Lake">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Pretty Church</div>
        <img src="mediaone/prettyChurch.png" alt="Pretty Church">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Stained Glass</div>
        <img src="mediaone/stainedGlass.png" alt="Stained Glass">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Three People</div>
        <img src="mediaone/threePeople.png" alt="Three People">
    </div>
    
    <div class="image-wrapper">
        <div class="image-caption">Two People</div>
        <img src="mediaone/twoPeople.png" alt="Two People">
    </div>


</body>
</html>



